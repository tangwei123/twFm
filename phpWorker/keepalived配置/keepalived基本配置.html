keepalived工作原理

        keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即虚拟路由冗余协议。

        虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，
        当backup收不到vrrp包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。


keepalived主要有三个模块，分别是core、check和vrrp。core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。vrrp模块是来实现VRRP协议的

keepalived只有一个配置文件keepalived.conf，里面主要包括以下几个配置区域，分别是global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance和virtual_server

一、global_defs区域，主要是配置故障发生时的通知对象以及机器标识：

        global_defs {
            notification_email { #故障发生时给谁发邮件通知
                a@abc.com
                b@abc.com
                ...
            }
            notification_email_from alert@abc.com #通知邮件从哪个地址发出
            smtp_server smtp.abc.com #通知邮件的smtp地址
            smtp_connect_timeout 30 #连接smtp服务器的超时时间
            enable_traps #开启SNMP陷阱
            router_id host163 #标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到
        }


二、static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置

        static_ipaddress {
            10.210.214.163/24 brd 10.210.214.255 dev eth0
            ...
        }
        static_routes {
            10.0.0.0/8 via 10.210.214.1 dev eth0
            ...
        }

三、vrrp_script区域，用来做健康检查的，当检查失败时会将vrrp_instance的priority减少相应的值。

        vrrp_script chk_http_port { #如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点
            script "/root/bin/nginx_check.sh"
            interval 1
            weight -10
        }

四、vrrp_instance和vrrp_sync_group区域

        vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。

        vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。


        vrrp_sync_group VG1 {
            group {
                VI_1
            }
        }


        vrrp_instance VI_1 {
            state MASTER #keepalived状态，主机为MASTER 备机为BACKUP
            interface eth0
            virtual_router_id 51 #取值在0-255之间，用来区分多个instance的VRRP组播
            mcast_src_ip 192.168.1.157 #修改vrrp组播包的源地址，默认源地址为master的IP。（由于是组播，因此即使修改了源地址，该master还是能收到回应的）
            priority 100 #用来选举master的，要成为master，那么这个选项的值最好高于其他机器50个点，该项取值范围是1-255（在此范围之外会被识别成默认值100）
            advert_int 1 #发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）
            authentication { #认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）
                auth_type PASS
                auth_pass 1111 #密码 MASTRE与BACKUP 一样
            }

            track_script {
                check_run
            }

            virtual_ipaddress {#对外虚拟的IP地址
                192.168.1.110
            }
        }










